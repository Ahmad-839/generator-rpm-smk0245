<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator RPM - Rencana Pembelajaran Mendalam</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome (CDN) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- STYLE DOKUMEN (Untuk Preview & Cetak) --- */
        .a4-page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 20mm 20mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-family: 'Times New Roman', Times, serif;
            font-size: 11pt;
            line-height: 1.3;
            color: #000;
            box-sizing: border-box;
        }

        .doc-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        .doc-table th, .doc-table td {
            border: 1px solid black;
            padding: 4px 6px;
            vertical-align: top;
            text-align: left;
        }
        .doc-table th {
            background-color: #E0E0E0;
            font-weight: bold;
            text-align: center;
        }

        .layout-table {
            width: 100%;
            border-collapse: collapse;
            border: none;
        }
        .layout-table td {
            border: none;
            padding: 2px;
            vertical-align: middle;
        }
        
        .section-title {
            font-weight: bold;
            background-color: #d1d5db; 
            padding: 5px;
            text-align: left;
            margin-top: 15px;
            border: 1px solid black;
            border-bottom: none;
            text-transform: uppercase;
        }

        .sub-section-title {
            font-weight: bold;
            margin-top: 5px;
            margin-bottom: 2px;
            text-decoration: underline;
        }

        .main-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 3px double black;
            padding-bottom: 10px;
        }
        .main-header h1 {
            font-size: 14pt;
            font-weight: bold;
            margin: 0;
            text-transform: uppercase;
        }
        .main-header h2 {
            font-size: 14pt;
            font-weight: bold;
            margin: 5px 0 0 0;
            text-transform: uppercase;
        }

        .signature-table {
            width: 100%;
            border: none;
            margin-top: 30px;
            page-break-inside: avoid;
        }
        .signature-table td {
            border: none;
            text-align: center;
            vertical-align: top;
        }
        .ttd-space {
            height: 70px;
        }

        .lkpd-box {
            border: 1px solid black;
            padding: 10px;
            margin-top: 5px;
        }
        .lkpd-area {
            border: 1px solid #999;
            height: 100px;
            width: 100%;
            margin-top: 5px;
            display: block;
        }

        .doc-link {
            color: #0000EE;
            text-decoration: underline;
            cursor: pointer;
        }

        /* Responsive Preview */
        @media (max-width: 768px) {
            .a4-page {
                width: 100%;
                padding: 10px;
                font-size: 10pt;
            }
        }

        /* Print Style */
        @media print {
            body * {
                visibility: hidden;
            }
            #previewArea, #previewArea * {
                visibility: visible;
            }
            #previewArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .a4-page {
                box-shadow: none;
                margin: 0;
                width: 100%;
                padding: 0;
            }
            a {
                text-decoration: underline !important;
                color: blue !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800 flex flex-col">

    <header class="bg-blue-800 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-lg md:text-xl font-bold leading-tight">GENERATOR RPP</h1>
                    <p class="text-xs md:text-sm opacity-90 font-medium">SMK 02 ISLAM 45 AMBULU</p>
                </div>
            </div>
            <div class="hidden md:block text-xs md:text-sm bg-blue-900 px-3 py-1 rounded-full border border-blue-700">
                Edisi 2025/2026
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex flex-col xl:flex-row gap-8 flex-grow">
        
        <!-- KOLOM INPUT (Kiri) -->
        <div class="w-full xl:w-1/3 bg-white rounded-xl shadow-md p-6 h-fit border-t-4 border-blue-600">
            <h2 class="text-lg font-bold text-gray-700 mb-4 pb-2 border-b flex items-center gap-2">
                <i class="fas fa-pen-to-square text-blue-600"></i> Data Perencanaan
            </h2>
            
            <form id="rpmForm" class="space-y-4 text-sm">
                
                <!-- 1. IDENTITAS -->
                <div class="bg-gray-50 p-3 rounded border">
                    <h3 class="font-bold text-blue-700 mb-2">1. Identitas Umum</h3>
                    <div class="space-y-2">
                        <input type="text" id="sekolah" class="w-full rounded border-gray-300 p-2" placeholder="Nama Sekolah" value="SMK 02 ISLAM 45 AMBULU" required>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="guru" class="w-full rounded border-gray-300 p-2" placeholder="Nama Guru" required>
                            <input type="text" id="nipGuru" class="w-full rounded border-gray-300 p-2" placeholder="NIP Guru (Opsional)">
                        </div>
                        <input type="text" id="mapel" class="w-full rounded border-gray-300 p-2" placeholder="Mata Pelajaran" required>
                        <input type="text" id="konsentrasi" class="w-full rounded border-gray-300 p-2" placeholder="Konsentrasi Keahlian (SMK) / -">
                        
                        <div class="grid grid-cols-2 gap-2">
                            <select id="jenjang" onchange="updateKelas()" class="w-full rounded border-gray-300 p-2" required>
                                <option value="">Jenjang...</option>
                                <option value="SD">SD</option>
                                <option value="SMP">SMP</option>
                                <option value="SMA">SMA</option>
                                <option value="SMK" selected>SMK</option>
                            </select>
                            <select id="kelas" onchange="updateFase()" class="w-full rounded border-gray-300 p-2" required>
                                <option value="">Kelas...</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="fase" class="w-full rounded bg-gray-100 border-gray-300 p-2" readonly placeholder="Fase">
                            <select id="semester" class="w-full rounded border-gray-300 p-2">
                                <option value="Ganjil">Ganjil</option>
                                <option value="Genap">Genap</option>
                            </select>
                        </div>
                        <input type="text" id="tahunAjar" class="w-full rounded border-gray-300 p-2" value="2025/2026">
                    </div>
                </div>

                <!-- 2. TOPIK & WAKTU -->
                <div class="bg-gray-50 p-3 rounded border">
                    <h3 class="font-bold text-blue-700 mb-2">2. Topik & Waktu</h3>
                    <div class="space-y-2">
                        <label class="block font-medium text-gray-600 text-xs">Topik Pembelajaran (Manual)</label>
                        <textarea id="materi" rows="2" class="w-full rounded border-gray-300 p-2" placeholder="Contoh: Ekosistem / Aljabar / Teks Prosedur" required></textarea>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block font-medium text-gray-600 text-xs">Jml Pertemuan</label>
                                <input type="number" id="jmlPertemuan" min="1" max="10" value="1" onchange="updatePedagogyInputs()" class="w-full rounded border-gray-300 p-2" required>
                            </div>
                            <div>
                                <label class="block font-medium text-gray-600 text-xs">Total Alokasi Waktu</label>
                                <input type="text" id="durasi" class="w-full rounded border-gray-300 p-2" placeholder="cth: 4 JP x 45'" required>
                            </div>
                        </div>
                        
                        <div id="pedagogyContainer" class="mt-2 pt-2 border-t border-gray-200">
                            <label class="block font-medium text-blue-600 text-xs mb-1">Praktik Pedagogis per Pertemuan:</label>
                            <div id="pedagogyInputs" class="space-y-1"></div>
                        </div>
                    </div>
                </div>

                <!-- 3. CAPAIAN & TUJUAN -->
                <div class="bg-gray-50 p-3 rounded border">
                    <h3 class="font-bold text-blue-700 mb-2">3. Capaian & Tujuan</h3>
                    <div class="space-y-2">
                        <label class="block font-medium text-gray-600 text-xs">Capaian Pembelajaran (CP)</label>
                        <textarea id="cp" rows="3" class="w-full rounded border-gray-300 p-2" placeholder="Salin CP dari Permendikdasmen..." required></textarea>
                        
                        <label class="block font-medium text-gray-600 text-xs">Tujuan Pembelajaran (TP) Umum</label>
                        <textarea id="tp" rows="3" class="w-full rounded border-gray-300 p-2" placeholder="Tujuan besar materi ini..." required></textarea>
                        <p class="text-[10px] text-gray-500 italic">*Generator akan otomatis memecah TP Umum ini menjadi TP per pertemuan.</p>
                        
                        <label class="block font-medium text-gray-600 text-xs mb-1">Dimensi Profil Lulusan (Pilih 8 Dimensi)</label>
                        <div class="grid grid-cols-2 gap-1 text-xs">
                            <label class="flex items-center"><input type="checkbox" name="dimensi" value="Keimanan dan Ketakwaan" checked class="mr-1">Keimanan & Ketakwaan</label>
                            <label class="flex items-center"><input type="checkbox" name="dimensi" value="Kewargaan" class="mr-1">Kewargaan</label>
                            <label class="flex items-center"><input type="checkbox" name="dimensi" value="Penalaran Kritis" checked class="mr-1">Penalaran Kritis</label>
                            <label class="flex items-center"><input type="checkbox" name="dimensi" value="Kreativitas" class="mr-1">Kreativitas</label>
                            <label class="flex items-center"><input type="checkbox" name="dimensi" value="Kolaborasi" class="mr-1">Kolaborasi</label>
                            <label class="flex items-center"><input type="checkbox" name="dimensi" value="Kemandirian" class="mr-1">Kemandirian</label>
                            <label class="flex items-center"><input type="checkbox" name="dimensi" value="Kesehatan" class="mr-1">Kesehatan</label>
                            <label class="flex items-center"><input type="checkbox" name="dimensi" value="Komunikasi" class="mr-1">Komunikasi</label>
                        </div>
                    </div>
                </div>

                <!-- 4. VALIDASI -->
                <div class="bg-gray-50 p-3 rounded border">
                     <h3 class="font-bold text-blue-700 mb-2">4. Validasi & Tanda Tangan</h3>
                     <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" id="kota" class="w-full rounded border-gray-300 p-2" placeholder="Tempat (Cth: Ambulu)" value="Ambulu" required>
                        <input type="text" id="tanggal" class="w-full rounded border-gray-300 p-2" placeholder="Tanggal (Cth: 20 Juli 2025)" required>
                    </div>
                     <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="kepsek" class="w-full rounded border-gray-300 p-2" placeholder="Nama Kepala Sekolah" required>
                        <input type="text" id="nipKepsek" class="w-full rounded border-gray-300 p-2" placeholder="NIP Kepsek (Opsional)">
                    </div>
                </div>

                <button type="button" onclick="generateRPM()" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-bold py-3 px-4 rounded-lg shadow-lg flex justify-center items-center gap-2">
                    <i class="fas fa-wand-magic-sparkles"></i> GENERATE RPM
                </button>
            </form>
        </div>

        <!-- KOLOM PREVIEW (Kanan) -->
        <div class="w-full xl:w-2/3 flex flex-col gap-4">
            
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-wrap gap-3 items-center justify-between sticky top-4 z-40">
                <div class="text-gray-700 font-bold flex items-center gap-2">
                    <i class="fas fa-file-lines text-blue-600"></i> Preview RPM
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="copyAndOpenDocs()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-3 rounded shadow"><i class="fas fa-copy"></i> Docs</button>
                    <button onclick="downloadWord()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-3 rounded shadow"><i class="fas fa-file-word"></i> Word</button>
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 px-3 rounded shadow"><i class="fas fa-file-pdf"></i> PDF</button>
                </div>
            </div>

            <div id="previewContainer" class="flex justify-center bg-gray-200 p-4 md:p-8 rounded-xl overflow-auto min-h-[800px]">
                <div id="previewArea" class="hidden"></div>
                <div id="placeholderState" class="flex flex-col items-center justify-center text-gray-400 mt-20">
                    <i class="fas fa-print text-6xl mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium">Dokumen belum dibuat.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts moved to bottom for better loading performance -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // Data Referensi
        const kelasOptions = {
            'SD': ['Kelas 1', 'Kelas 2', 'Kelas 3', 'Kelas 4', 'Kelas 5', 'Kelas 6'],
            'SMP': ['Kelas 7', 'Kelas 8', 'Kelas 9'],
            'SMA': ['Kelas 10', 'Kelas 11', 'Kelas 12'],
            'SMK': ['Kelas 10', 'Kelas 11', 'Kelas 12']
        };
        const faseMapping = {
            'Kelas 1': 'Fase A', 'Kelas 2': 'Fase A',
            'Kelas 3': 'Fase B', 'Kelas 4': 'Fase B',
            'Kelas 5': 'Fase C', 'Kelas 6': 'Fase C',
            'Kelas 7': 'Fase D', 'Kelas 8': 'Fase D', 'Kelas 9': 'Fase D',
            'Kelas 10': 'Fase E', 'Kelas 11': 'Fase F', 'Kelas 12': 'Fase F'
        };
        const pedagogyOptions = [
            "Inkuiri-Discovery Learning", "Project Based Learning (PjBL)", "Problem Based Learning (PBL)",
            "Game Based Learning", "Station Learning", "Teaching Factory (TeFa)"
        ];

        // --- Fungsi UI ---
        function updateKelas() {
            const jenjang = document.getElementById('jenjang').value;
            const kelasSelect = document.getElementById('kelas');
            kelasSelect.innerHTML = '<option value="">Pilih Kelas</option>';
            if (jenjang && kelasOptions[jenjang]) {
                kelasOptions[jenjang].forEach(cls => {
                    const opt = document.createElement('option');
                    opt.value = cls; opt.textContent = cls; kelasSelect.appendChild(opt);
                });
            }
            updateFase();
        }
        function updateFase() {
            const kelas = document.getElementById('kelas').value;
            document.getElementById('fase').value = (kelas && faseMapping[kelas]) ? faseMapping[kelas] : "";
        }
        function updatePedagogyInputs() {
            const count = document.getElementById('jmlPertemuan').value;
            const container = document.getElementById('pedagogyInputs');
            container.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                container.innerHTML += `<div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-500 w-8">P${i}:</span><select id="pedagogy-${i}" class="flex-1 rounded border-gray-300 text-xs p-1">${pedagogyOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}</select></div>`;
            }
        }
        
        // Initial setup using DOMContentLoaded for faster rendering
        document.addEventListener('DOMContentLoaded', function() {
            updateKelas();
            updatePedagogyInputs();
        });

        // --- LOGIKA GENERATOR AI ---
        function generateStudentID(jenjang) {
            let pengetahuan, minat, latar, kebutuhan;
            
            if (jenjang === 'SD') {
                pengetahuan = "Mayoritas murid memiliki pemahaman konsep dasar yang bersifat konkret. Membutuhkan jembatan untuk memahami konsep abstrak.";
                minat = "Tinggi terhadap aktivitas yang melibatkan gerak, visual menarik, dan permainan (gamifikasi).";
                latar = "Latar belakang keluarga beragam, dukungan orang tua sangat berpengaruh. Ketergantungan pada guru masih tinggi.";
                kebutuhan = "Membutuhkan pembelajaran yang terstruktur, instruksi yang jelas, dan penguatan positif segera.";
            } else if (jenjang === 'SMP') {
                pengetahuan = "Mulai mampu berpikir logis untuk masalah konkret dan menuju abstrak. Memiliki pengetahuan awal yang bervariasi.";
                minat = "Tertarik pada isu-isu sosial, teknologi, dan interaksi teman sebaya. Menyukai tantangan yang relevan dengan dunia mereka.";
                latar = "Berada pada masa transisi remaja, emosi fluktuatif. Pengaruh teman sebaya (peer group) sangat kuat.";
                kebutuhan = "Membutuhkan ruang untuk eksplorasi diri, validasi, dan diskusi kelompok yang terarah (scaffolding).";
            } else {
                pengetahuan = "Mampu berpikir abstrak, kritis, dan analitis. Memiliki pengetahuan prasyarat yang lebih kompleks.";
                minat = "Berorientasi pada karir masa depan, hobi spesifik, dan isu-isu global atau aktual.";
                latar = "Mulai mandiri dalam mengambil keputusan. Memiliki identitas diri yang mulai terbentuk.";
                kebutuhan = "Membutuhkan otonomi dalam belajar, tantangan pemecahan masalah nyata (HOTS), dan relevansi materi dengan karir.";
            }
            return { pengetahuan, minat, latar, kebutuhan };
        }

        function generateMaterialID(materi) {
            return {
                jenis: `Faktual (fakta-fakta dasar tentang ${materi}), Konseptual (prinsip dan definisi), serta Prosedural (langkah-langkah atau cara kerja).`,
                relevansi: `Materi ${materi} sangat relevan untuk memecahkan masalah sehari-hari dan menjadi dasar kompetensi untuk jenjang berikutnya.`,
                kesulitan: "Tingkat kesulitan menengah (Medium). Konsep abstrak memerlukan visualisasi atau analogi konkret.",
                struktur: "Disusun secara hierarkis: mulai dari definisi, karakteristik, hingga analisis dan aplikasi dalam kasus nyata.",
                integrasi: "Mengintegrasikan nilai-nilai Profil Pelajar Pancasila, terutama Bernalar Kritis dan Gotong Royong dalam penyelesaian masalah."
            };
        }

        function generateLintasDisiplin(mapel) {
            const m = mapel.toLowerCase();
            if (m.includes("matematika")) return "Fisika (Logika), Seni (Pola)";
            if (m.includes("bahasa")) return "IPS (Konteks), Sejarah (Literasi)";
            if (m.includes("ipa")) return "Matematika (Data), Bahasa (Laporan)";
            return "Pendidikan Karakter, Literasi Digital";
        }

        function generateKKTP(materi) {
            return `
            <ul style="margin-left: 15px; list-style-type: disc;">
                <li>Murid mampu menjelaskan konsep ${materi} dengan bahasanya sendiri (Berkesadaran).</li>
                <li>Murid mampu menerapkan prinsip ${materi} dalam menyelesaikan masalah kontekstual (Bermakna).</li>
                <li>Murid menunjukkan antusiasme dan partisipasi aktif selama proses eksplorasi ${materi} (Menggembirakan).</li>
            </ul>`;
        }

        function generateDigital(tp) {
            return "Platform Quizizz/Kahoot untuk asesmen formatif, Video Youtube untuk apersepsi, dan Canva/Google Slides untuk presentasi hasil karya.";
        }

        function getPedagogyDescription(model) {
            const descriptions = {
                "Inkuiri-Discovery Learning": "Pembelajaran yang menekankan pada proses penemuan konsep secara mandiri oleh murid melalui observasi, eksperimen, dan pembuktian untuk membangun pemahaman yang mendalam.",
                "Project Based Learning (PjBL)": "Model pembelajaran berbasis proyek yang menuntut murid menghasilkan produk nyata melalui kegiatan eksplorasi, penilaian, interpretasi, sintesis, dan informasi.",
                "Problem Based Learning (PBL)": "Pendekatan pembelajaran yang menghadapkan murid pada masalah autentik dan kompleks sebagai pemicu untuk melakukan investigasi dan inkuiri.",
                "Game Based Learning": "Pemanfaatan dinamika permainan dalam proses pembelajaran untuk meningkatkan motivasi dan keterlibatan murid dalam memahami materi.",
                "Station Learning": "Metode pembelajaran rotasi stasiun yang memberikan variasi aktivitas belajar (visual, auditori, kinestetik) dalam satu pertemuan untuk diferensiasi.",
                "Teaching Factory (TeFa)": "Model pembelajaran berbasis produksi/jasa yang mengacu pada standar industri, dilaksanakan dalam suasana industri yang sesungguhnya."
            };
            return descriptions[model] || "Pendekatan pembelajaran aktif yang berpusat pada murid.";
        }

        function generateSpecificTP(materi, pedagogy, meeting, total) {
            let verb = "";
            let context = "";

            if (total === 1) {
                 verb = "memahami, menerapkan, dan mengevaluasi";
                 context = "dalam satu rangkaian aktivitas terpadu";
            } else if (meeting === 1) {
                 verb = "mengidentifikasi dan menjelaskan";
                 context = "melalui pengamatan dan diskusi awal";
                 if (pedagogy.includes("PjBL")) verb = "merancang perencanaan proyek terkait";
                 if (pedagogy.includes("Problem")) verb = "mengidentifikasi masalah utama terkait";
            } else if (meeting === total) {
                 verb = "mengevaluasi dan menyimpulkan";
                 context = "melalui presentasi hasil karya dan refleksi";
            } else {
                 verb = "menerapkan dan menganalisis";
                 context = "melalui praktik/penyelidikan mendalam";
                 if (pedagogy.includes("PjBL")) verb = "melaksanakan pembuatan produk";
            }

            return `Murid mampu <strong>${verb}</strong> konsep/prosedur ${materi} ${context} secara kolaboratif.`;
        }

        function generateActivities(pedagogy, materi, meeting, total) {
            let focus = "";
            let kegiatanInti = "";
            let tujuanPertemuan = "";

            if (total == 1) {
                focus = "Siklus Penuh: Konsep hingga Refleksi";
                tujuanPertemuan = "Memahami dan menerapkan konsep dasar secara langsung.";
                if (pedagogy.includes("PjBL")) kegiatanInti = `Murid dibentuk kelompok, menyepakati tema proyek singkat tentang ${materi}, menyusun jadwal cepat, dan memulai pembuatan rancangan awal proyek.`;
                else if (pedagogy.includes("Problem")) kegiatanInti = `Murid mengidentifikasi masalah pada studi kasus ${materi}, berdiskusi mencari akar masalah, dan mempresentasikan solusi awal.`;
                else kegiatanInti = `Murid melakukan eksplorasi konsep ${materi} melalui literasi, diskusi kelompok untuk pendalaman, dan mengerjakan lembar kerja pemahaman.`;
            } 
            else if (meeting == 1) {
                focus = "Pengenalan Masalah & Konsep Dasar";
                tujuanPertemuan = "Membangun pemahaman awal dan ketertarikan pada topik.";
                if (pedagogy.includes("PjBL")) kegiatanInti = `Murid diperkenalkan dengan pertanyaan esensial terkait ${materi}. Murid membentuk kelompok dan menyusun <strong>Perencanaan Proyek</strong> (jadwal dan alat bahan).`;
                else if (pedagogy.includes("Problem")) kegiatanInti = `Murid melakukan <strong>Orientasi Masalah</strong>. Guru menyajikan fenomena tentang ${materi}, murid merumuskan pertanyaan masalah yang akan diselesaikan.`;
                else kegiatanInti = `Murid melakukan observasi awal dan eksplorasi konsep dasar ${materi}. Fokus pada pengumpulan informasi dan identifikasi kata kunci.`;
            } 
            else if (meeting == total) {
                focus = "Presentasi Hasil & Evaluasi Akhir";
                tujuanPertemuan = "Mengkomunikasikan hasil belajar dan evaluasi menyeluruh.";
                if (pedagogy.includes("PjBL")) kegiatanInti = `Murid melakukan <strong>Gelar Karya</strong> produk ${materi}. Kelompok lain memberikan apresiasi dan masukan. Guru melakukan evaluasi terhadap produk.`;
                else if (pedagogy.includes("Problem")) kegiatanInti = `Murid menyajikan laporan hasil pemecahan masalah ${materi}. Melakukan analisis dan evaluasi terhadap proses pemecahan masalah yang dilakukan.`;
                else kegiatanInti = `Murid melakukan reviu materi ${materi}, mengerjakan asesmen sumatif, dan melakukan refleksi mendalam tentang manfaat materi ini.`;
            } 
            else {
                focus = "Pendalaman Materi & Proses Berkarya";
                tujuanPertemuan = "Mengembangkan keterampilan dan analisis mendalam.";
                if (pedagogy.includes("PjBL")) kegiatanInti = `Murid melaksanakan <strong>Pembuatan Proyek</strong> ${materi} sesuai jadwal. Guru memonitor kemajuan dan membimbing penyelesaian kendala teknis.`;
                else if (pedagogy.includes("Problem")) kegiatanInti = `Murid melakukan <strong>Penyelidikan Mandiri/Kelompok</strong>. Mengumpulkan data valid untuk menjawab masalah ${materi} yang telah dirumuskan.`;
                else kegiatanInti = `Murid melakukan elaborasi pemahaman ${materi} melalui studi kasus, praktik, atau latihan soal terbimbing untuk menguatkan konsep.`;
            }

            return `
            <div style="margin-bottom: 5px;"><strong>A. Kegiatan Awal (10 Menit) - <em>Berkesadaran (Mindfulness)</em></strong></div>
            <div style="text-align: justify; margin-bottom: 8px;">Guru menyapa dan memotivasi murid. Mengaitkan materi dengan pertemuan sebelumnya. Menyampaikan tujuan: <em>${tujuanPertemuan}</em>. Melakukan teknik "Stop" sejenak untuk melatih fokus.</div>
            
            <div style="margin-bottom: 5px;"><strong>B. Kegiatan Inti (${focus}) - <em>Bermakna (Meaningfulness)</em></strong></div>
            <div style="text-align: justify; margin-bottom: 8px;">(Sintaks Model: ${pedagogy})<br>${kegiatanInti}</div>
            
            <div style="margin-bottom: 5px;"><strong>C. Kegiatan Penutup (10 Menit) - <em>Menggembirakan (Joyfulness)</em></strong></div>
            <div style="text-align: justify;">Murid menyimpulkan poin kunci pertemuan ini. Guru memberikan apresiasi dan umpan balik positif. Melakukan refleksi perasaan: "Bagaimana perasaan kalian setelah belajar hari ini?". Doa penutup.</div>
            `;
        }

        function generateAssessment(materi) {
            return {
                awal: `<strong>Diagnostik Kognitif:</strong><br>1. Apa yang kamu ketahui tentang ${materi}?<br>2. Sebutkan satu contoh ${materi} di sekitarmu!`,
                proses: `<strong>Formatif (Observasi):</strong><br>Mengamati keterlibatan murid saat diskusi, kemampuan mengajukan pertanyaan kritis, dan kerjasama tim dalam menyelesaikan tantangan ${materi}.`,
                akhir: `<strong>Sumatif (Tes/Produk):</strong><br>1. Buatlah kesimpulan tentang prinsip kerja ${materi}!<br>2. Selesaikan studi kasus berikut: [Kasus relevan dengan ${materi}].`
            };
        }

        function generateAttachments(materi, mapel, kelas, pedagogy, jenjang) {
            let langkahKerja = "";
            
            if (pedagogy.includes("PjBL")) {
                langkahKerja = `
                <p><strong>A. Perencanaan Proyek</strong></p>
                <p>Tuliskan rencana proyek yang akan kalian buat:</p>
                <div class="lkpd-area" style="height:50px;"></div>
                <p><strong>B. Jadwal Pelaksanaan</strong></p>
                <table style="width:100%; border:1px solid black; border-collapse:collapse; margin-top:5px;">
                    <tr><th style="border:1px solid black;">Kegiatan</th><th style="border:1px solid black;">Waktu</th></tr>
                    <tr><td style="border:1px solid black; height:30px;"></td><td style="border:1px solid black;"></td></tr>
                    <tr><td style="border:1px solid black; height:30px;"></td><td style="border:1px solid black;"></td></tr>
                </table>`;
            } else if (pedagogy.includes("Problem")) {
                langkahKerja = `
                <p><strong>A. Identifikasi Masalah</strong></p>
                <p>Tuliskan rumusan masalah yang kalian temukan:</p>
                <div class="lkpd-area" style="height:50px;"></div>
                <p><strong>B. Analisis Penyebab & Solusi</strong></p>
                <div class="lkpd-area"></div>`;
            } else {
                langkahKerja = `
                <p><strong>A. Pengamatan</strong></p>
                <p>Amati materi/video yang disajikan, catat poin penting:</p>
                <div class="lkpd-area" style="height:60px;"></div>
                <p><strong>B. Diskusi & Jawab</strong></p>
                <p>1. Jelaskan konsep utama dari ${materi}!</p>
                <div class="lkpd-area" style="height:40px;"></div>`;
            }

            const lkpdHTML = `
            <div class="lkpd-box" style="page-break-inside:avoid;">
                <div style="text-align:center; border-bottom:2px solid black; margin-bottom:10px; padding-bottom:5px;">
                    <h3 style="margin:0;">LEMBAR KERJA MURID (LKM)</h3>
                    <p style="margin:0;">Mata Pelajaran: ${mapel} | Kelas: ${kelas}</p>
                </div>
                <div>
                    <p><strong>Nama Kelompok/Murid:</strong> ........................................................</p>
                    <p><strong>Topik Materi:</strong> ${materi}</p>
                </div>
                <hr style="margin:10px 0;">
                <div>
                    <strong>TUJUAN KEGIATAN:</strong><br>
                    Murid mampu memahami dan menerapkan konsep ${materi} melalui aktivitas ${pedagogy}.
                </div>
                <div style="margin-top:10px;">
                    <strong>LANGKAH KERJA:</strong>
                    ${langkahKerja}
                </div>
                <div style="margin-top:10px;">
                    <strong>KESIMPULAN:</strong>
                    <div class="lkpd-area" style="height:60px;"></div>
                </div>
            </div>`;

            const query = encodeURIComponent(`${materi} ${mapel} ${jenjang}`);
            const links = `
                <br><br><strong>Referensi Digital & Video:</strong>
                <ul style="margin-top: 5px; list-style-type: none; padding-left: 0;">
                    <li style="margin-bottom: 5px;">
                        <i class="fab fa-youtube" style="color: red; margin-right: 5px;"></i>
                        <a href="https://www.youtube.com/results?search_query=Video+Pembelajaran+${query}" target="_blank" class="doc-link" style="color:blue; text-decoration:underline;">
                            Video Pembelajaran "${materi}" (YouTube)
                        </a>
                    </li>
                    <li style="margin-bottom: 5px;">
                        <i class="fab fa-google" style="color: #4285F4; margin-right: 5px;"></i>
                        <a href="https://www.google.com/search?q=Materi+${query}+Kurikulum+Merdeka" target="_blank" class="doc-link" style="color:blue; text-decoration:underline;">
                            Artikel & Modul "${materi}" (Google)
                        </a>
                    </li>
                     <li>
                        <i class="fas fa-book-open" style="color: #2563eb; margin-right: 5px;"></i>
                        <a href="https://buku.kemdikbud.go.id/" target="_blank" class="doc-link" style="color:blue; text-decoration:underline;">
                            Buku Teks Kurikulum Merdeka (SIBI)
                        </a>
                    </li>
                </ul>
            `;

            return {
                lkpd: lkpdHTML,
                glosarium: `<strong>${materi}</strong>: Konsep inti pelajaran.<br><strong>Deep Learning</strong>: Belajar berkesadaran, bermakna, menggembirakan.`,
                bacaan: `Buku Paket ${mapel} Kurikulum Merdeka, Artikel online tentang "${materi}".${links}`
            };
        }

        // --- FUNGSI UTAMA GENERATE ---
        function generateRPM() {
            if (!document.getElementById('rpmForm').checkValidity()) {
                alert("Lengkapi semua data!"); return;
            }

            const d = {
                sekolah: document.getElementById('sekolah').value,
                kota: document.getElementById('kota').value,
                tanggal: document.getElementById('tanggal').value,
                guru: document.getElementById('guru').value,
                nipGuru: document.getElementById('nipGuru').value || "-",
                mapel: document.getElementById('mapel').value,
                konsentrasi: document.getElementById('konsentrasi').value || "-",
                jenjang: document.getElementById('jenjang').value,
                kelas: document.getElementById('kelas').value,
                fase: document.getElementById('fase').value,
                semester: document.getElementById('semester').value,
                tahun: document.getElementById('tahunAjar').value,
                materi: document.getElementById('materi').value,
                jmlPertemuan: parseInt(document.getElementById('jmlPertemuan').value),
                durasi: document.getElementById('durasi').value,
                cp: document.getElementById('cp').value,
                tp: document.getElementById('tp').value,
                kepsek: document.getElementById('kepsek').value,
                nipKepsek: document.getElementById('nipKepsek').value || "-"
            };

            const checkboxes = document.querySelectorAll('input[name="dimensi"]:checked');
            let selectedDimensi = [];
            checkboxes.forEach((cb) => { selectedDimensi.push(cb.value); });
            
            const murid = generateStudentID(d.jenjang);
            const mat = generateMaterialID(d.materi);
            const kktp = generateKKTP(d.materi);
            const lintas = generateLintasDisiplin(d.mapel);
            const digital = generateDigital(d.tp);
            const asesmen = generateAssessment(d.materi);
            const mainPedagogy = document.getElementById('pedagogy-1').value; 
            const lampiran = generateAttachments(d.materi, d.mapel, d.kelas, mainPedagogy, d.jenjang);

            let pertemuanContent = "";
            let tpContent = "<ul style='margin-left:15px; list-style:disc;'>";
            let uniquePedagogies = new Set();
            let tpDetailed = "<div style='margin-top:5px;'><ol style='margin-left:15px; list-style:decimal;'>";
            
            for (let i = 1; i <= d.jmlPertemuan; i++) {
                const ped = document.getElementById(`pedagogy-${i}`).value;
                uniquePedagogies.add(ped);
                
                const specificTP = generateSpecificTP(d.materi, ped, i, d.jmlPertemuan);
                tpDetailed += `<li style="margin-bottom:3px;"><strong>Pertemuan ${i}:</strong> ${specificTP}</li>`;

                pertemuanContent += `
                <div style="border:1px solid black; padding:10px; margin-bottom:10px; page-break-inside:avoid;">
                    <div style="font-weight:bold; border-bottom:1px solid #ccc; margin-bottom:5px;">Pertemuan Ke-${i} (${ped})</div>
                    ${generateActivities(ped, d.materi, i, d.jmlPertemuan)}
                </div>`;
            }
            tpDetailed += "</ol></div>";
            tpContent += "</ul>";

            let pedagogiDesc = "<ul style='margin-left:15px; list-style:disc;'>";
            uniquePedagogies.forEach(ped => {
                pedagogiDesc += `<li><strong>${ped}:</strong> ${getPedagogyDescription(ped)}</li>`;
            });
            pedagogiDesc += "</ul>";

            const allDimensions = [
                "Keimanan dan Ketakwaan", "Kewargaan", "Penalaran Kritis", "Kreativitas", 
                "Kolaborasi", "Kemandirian", "Kesehatan", "Komunikasi"
            ];
            
            let dimensiHTML = '<table class="layout-table">';
            for (let i = 0; i < allDimensions.length; i += 2) {
                dimensiHTML += '<tr>';
                
                let dim1 = allDimensions[i];
                let check1 = selectedDimensi.includes(dim1) ? '&#9745;' : '&#9744;';
                dimensiHTML += `<td>${check1} ${dim1}</td>`;

                if (i + 1 < allDimensions.length) {
                    let dim2 = allDimensions[i+1];
                    let check2 = selectedDimensi.includes(dim2) ? '&#9745;' : '&#9744;';
                    dimensiHTML += `<td>${check2} ${dim2}</td>`;
                } else {
                     dimensiHTML += `<td></td>`;
                }
                
                dimensiHTML += '</tr>';
            }
            dimensiHTML += '</table>';

            const docHTML = `
            <div class="a4-page">
                <div class="main-header">
                    <h1>RENCANA PEMBELAJARAN MENDALAM</h1>
                    <h2>SMK 02 ISLAM 45 AMBULU</h2>
                </div>

                <div class="section-title">IDENTITAS UMUM</div>
                <table class="doc-table">
                    <tr><td width="25%"><strong>Nama Guru</strong></td><td>${d.guru}</td></tr>
                    <tr><td><strong>Mata Pelajaran</strong></td><td>${d.mapel}</td></tr>
                    <tr><td><strong>Fase / Kelas</strong></td><td>${d.fase} / ${d.kelas}</td></tr>
                    <tr><td><strong>Semester / Tahun</strong></td><td>${d.semester} / ${d.tahun}</td></tr>
                    <tr><td><strong>Alokasi Waktu</strong></td><td>${d.durasi} (${d.jmlPertemuan} Pertemuan)</td></tr>
                </table>

                <div class="section-title">A. IDENTIFIKASI</div>
                
                <div class="sub-section-title">1. Identifikasi Murid (Kesiapan Belajar)</div>
                <table class="doc-table">
                    <tr><td width="30%"><strong>Pengetahuan Awal</strong></td><td>${murid.pengetahuan}</td></tr>
                    <tr><td><strong>Minat & Motivasi</strong></td><td>${murid.minat}</td></tr>
                    <tr><td><strong>Latar Belakang</strong></td><td>${murid.latar}</td></tr>
                    <tr><td><strong>Kebutuhan Belajar</strong></td><td>${murid.kebutuhan}</td></tr>
                </table>

                <div class="sub-section-title">2. Identifikasi Materi Pelajaran</div>
                <table class="doc-table">
                    <tr><td width="30%"><strong>Jenis Pengetahuan</strong></td><td>${mat.jenis}</td></tr>
                    <tr><td><strong>Relevansi Kehidupan</strong></td><td>${mat.relevansi}</td></tr>
                    <tr><td><strong>Tingkat Kesulitan</strong></td><td>${mat.kesulitan}</td></tr>
                    <tr><td><strong>Struktur Materi</strong></td><td>${mat.struktur}</td></tr>
                    <tr><td><strong>Integrasi Nilai</strong></td><td>${mat.integrasi}</td></tr>
                </table>

                <div class="sub-section-title">3. Dimensi Profil Lulusan</div>
                <div style="border:1px solid black; padding:5px; margin-bottom:10px;">
                    ${dimensiHTML}
                </div>

                <div class="section-title">B. DESAIN PEMBELAJARAN</div>
                <table class="doc-table">
                    <tr><td width="30%"><strong>1. Capaian Pembelajaran</strong></td><td>${d.cp}</td></tr>
                    <tr><td><strong>2. Lintas Disiplin Ilmu</strong></td><td>${lintas}</td></tr>
                    <tr><td><strong>3. Tujuan Pembelajaran</strong></td><td><strong>TP Umum:</strong> ${d.tp}<br><strong>Rincian TP per Pertemuan:</strong>${tpDetailed}</td></tr>
                    <tr><td><strong>4. KKTP</strong></td><td>${kktp}</td></tr>
                    <tr><td><strong>5. Topik Pembelajaran</strong></td><td>${d.materi}</td></tr>
                    <tr><td><strong>6. Praktik Pedagogis</strong></td><td>${pedagogiDesc}</td></tr>
                    <tr><td><strong>7. Pemanfaatan Digital</strong></td><td>${digital}</td></tr>
                </table>

                <div class="section-title">C. PENGALAMAN BELAJAR</div>
                <p style="font-size:10pt; font-style:italic; margin-bottom:5px;">Langkah pembelajaran berkelanjutan sesuai TP dan materi.</p>
                ${pertemuanContent}

                <div class="section-title">D. ASESMEN PEMBELAJARAN</div>
                <table class="doc-table">
                    <tr><td><strong>1. Asesmen Awal</strong></td><td>${asesmen.awal}</td></tr>
                    <tr><td><strong>2. Asesmen Proses</strong></td><td>${asesmen.proses}</td></tr>
                    <tr><td><strong>3. Asesmen Akhir</strong></td><td>${asesmen.akhir}</td></tr>
                </table>

                <div class="section-title">E. LAMPIRAN-LAMPIRAN</div>
                <div>
                    <div class="sub-section-title">1. Lembar Kerja Murid (LKM)</div>
                    ${lampiran.lkpd}
                    
                    <div class="sub-section-title" style="margin-top:15px;">2. Glosarium</div>
                    <div style="border:1px solid black; padding:5px;">${lampiran.glosarium}</div>
                    
                    <div class="sub-section-title" style="margin-top:15px;">3. Bahan Bacaan & Referensi</div>
                    <div style="border:1px solid black; padding:5px;">${lampiran.bacaan}</div>
                </div>

                <table class="signature-table">
                    <tr>
                        <td width="40%">Mengetahui,<br>Kepala Sekolah<div class="ttd-space"></div><strong><u>${d.kepsek}</u></strong><br>NIP. ${d.nipKepsek}</td>
                        <td width="20%"></td>
                        <td width="40%">${d.kota}, ${d.tanggal}<br>Guru Mata Pelajaran<div class="ttd-space"></div><strong><u>${d.guru}</u></strong><br>NIP. ${d.nipGuru}</td>
                    </tr>
                </table>
            </div>`;

            document.getElementById('previewArea').innerHTML = docHTML;
            document.getElementById('previewArea').classList.remove('hidden');
        }

        function downloadPDF() {
            const el = document.getElementById('previewArea');
            html2pdf().set({ margin:0, filename:`RPM_${document.getElementById('materi').value.substring(0,10)}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'} }).from(el).save();
        }
        function downloadWord() {
            const el = document.getElementById('previewArea');
            const css = `<style>
                body { font-family: 'Times New Roman', serif; }
                table { border-collapse: collapse; width: 100%; }
                td, th { border: 1px solid black; padding: 5px; }
                .layout-table td { border: none !important; padding: 2px; }
                .lkpd-box { border: 1px solid black; padding: 10px; }
                .signature-table td { border: none !important; }
            </style>`;
            const blob = new Blob(['\ufeff', `<html><head>${css}</head><body>${el.innerHTML}</body></html>`], {type:'application/msword'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); a.href=url; a.download=`RPM_${document.getElementById('materi').value.substring(0,10)}.doc`; a.click();
        }
        async function copyAndOpenDocs() {
            const el = document.getElementById('previewArea');
            await navigator.clipboard.write([new ClipboardItem({'text/html':new Blob([el.innerHTML],{type:'text/html'}), 'text/plain':new Blob([el.innerText],{type:'text/plain'})})]);
            if(confirm("Tersalin! Buka Google Docs?")) window.open('https://docs.new', '_blank');
        }
    </script>
</body>
</html>